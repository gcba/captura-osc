<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <title>Fiebre</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    
    <script src='http://localhost:3000/socket.io/socket.io.js' type="text/javascript" charset="utf-8"></script>
    <script src='libs/jquery-1.11.1.min.js' type="text/javascript" charset="utf-8"></script>
    <script src='libs/d3.v3.min.js' type="text/javascript" charset="utf-8"></script>
    <script>
        var max = 512;
        var socket = io.connect('//localhost:3000');

        //vars del gráfico
        var width = $(window).width();
        var height = $(window).height();
        var n = 50, // cantidad de ticks en X
            data = d3.range(n);
        var margin = {top: 0, right: 0, bottom: 0, left: 0};
    </script>

    <style>
        html, body{
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            background-color: #f2f2f2;
        }

        #fiebre{
            width: 100%;
            height: 100%;
        }

        svg {
            font: 10px Arial, sans-serif;
        }

        .line {
            fill: none;
            stroke: #333333;
            stroke-width: 10px;
        }

        .axis {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }
    </style>
</head>

<body>

    <div id="fiebre"></div>

    <script>
        var x = d3.scale.linear()
            .domain([ 1 , n - 2 ])
            .range([ 0 , width ]);

        var y = d3.scale.linear()
            .domain([ 0 , max ])
            .range([ 0 , height ]);

        var line = d3.svg.line()
            .interpolate("basis")
            .x(function(d, i) { return x(i); })
            .y(function(d, i) { return y(d); });

        var svg = d3.select("#fiebre").append("svg")
            .attr("width", '100%')
            .attr("height", '100%')
            .attr('viewBox','-50 0 '+Math.max(width,height) +' '+Math.min(width,height) )
            .attr('preserveAspectRatio','xMidYMid') //none para streched
            .append("g")
            .attr("transform", "translate(" + Math.min(width,height) /1000 + "," + Math.min(height,width) /1000 + ")");

        svg.append("defs").append("clipPath")
            .attr("id", "clip")
            .append("rect")
            .attr("width", width)
            .attr("height", height);

        var path = svg.append("g")
            .attr("clip-path", "url(#clip)")
            .append("path")
            .datum(data)
            .attr("class", "line")
            .attr("d", line);

        texto = svg.append("text")
            .text("")
            .attr("text-anchor", "right")
            .style("font-size","60px")
            .attr("dy", width / 3)
            .attr("dx", height / 1.5);

        svg.append("g")
            .attr("class", "y axis")
            .call(d3.svg.axis().scale(y).orient("left"));

        // listener de mensajes de socket.io
        socket.on('message', function (message) {

            // solo proceso los mensajes del /sensor_0
            if (message.split(",")[0] === "/sensor_0"){

                if (max < parseInt(message.split(",")[1]) ){
                    max = parseInt( message.split(",")[1] ) ;

                    //actualizo eje Y con el nuevo máximo
                    y = d3.scale.linear()
                        .domain([ 0 , max ])
                        .range([ 0 , height ]);

                    //call sin transicion porque va tan rapido que se pierde
                    svg.select(".y")
                        .call(d3.svg.axis().scale(y).orient("left"));
                }

                var rango = d3.scale.linear().domain([0, max]).range([ 0.2 , max]);
                data.push(rango (message.split(",")[1]) );

                // redibuja y corre la linea
                path
                    .attr("d", line)
                    .attr("transform", null)
                    .transition()
                    .duration(500)
                    .ease("linear")
                    .attr("transform", "translate(" + x(0) + ",0)");

                // elimino el dato mas viejo del array
                data.shift();

                // actualizo el texto con el valor actual
                svg.select("text")
                    .text(function () {
                        return (message.split(",")[1]);

                } );

            } // end if
        }); // end listener   

    </script>

</body>
</html>