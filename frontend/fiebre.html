<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <title>Fiebre</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    
    <script src='http://localhost:3000/socket.io/socket.io.js' type="text/javascript" charset="utf-8"></script>
    <script src='libs/jquery-1.11.1.min.js' type="text/javascript" charset="utf-8"></script>
    <script src='libs/d3.v3.min.js' type="text/javascript" charset="utf-8"></script>
    <script>
        var max = 600;
        var socket = io.connect('//localhost:3000');
    </script>

    <style>
        html, body{
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            background-color: #f2f2f2;
        }

        #fiebre{
            width: 100%;
            height: 100%;
        }

        svg {
            font: 10px Arial, sans-serif;
        }

        .line {
            fill: none;
            stroke: #333333;
            stroke-width: 10px;
        }

    </style>    
</head>

<body>
    <div id="fiebre"></div>



    <script>
        var width = $(window).width() - 10;
        var height = $(window).height() - 10;
        var n = 50, // cantidad de puntos por pantalla
            data = d3.range(n);

        var margin = {top: 0, right: 0, bottom: 0, left: 0};

        var x = d3.scale.linear()
            .domain([1, n - 2])
            .range([0, width]);

        var y = d3.scale.linear()
            .domain([0, 1])
            .range([height, 0]);

        var line = d3.svg.line()
            .interpolate("basis")
            .x(function(d, i) { return x(i); })
            .y(function(d, i) { return y(d); });

        var svg = d3.select("#fiebre").append("svg")
        .attr("width", '100%')
        .attr("height", '100%')
        .attr('viewBox','0 0 '+Math.max(width,height) +' '+Math.min(width,height) )
        .attr('preserveAspectRatio','xMidYMid') //none para streched
        .append("g")
        .attr("transform", "translate(" + Math.min(width,height) /1000 + "," + Math.min(height,width) /1000 + ")");


        svg.append("defs").append("clipPath")
            .attr("id", "clip")
            .append("rect")
            .attr("width", width)
            .attr("height", height);


        var path = svg.append("g")
            .attr("clip-path", "url(#clip)")
            .append("path")
            .datum(data)
            .attr("class", "line")
            .attr("d", line);

        texto = svg.append("text")
            .text("")
            .attr("text-anchor", "right")
            .style("font-size","60px")
            .attr("dy", width / 3)
            .attr("dx", height / 1.5);


        socket.on('message', function (message) {

            if (message.split(",")[0] === "/sensor_0"){
                if (max < message.split(",")[1]){max = message.split(",")[1];}

                var opacidad = d3.scale.linear().domain([0, max]).range([1, 0.2]);
                data.push(opacidad (message.split(",")[1]) );
                // redibuja y corre la linea
                path
                    .attr("d", line)
                    .attr("transform", null)
                    .transition()
                    .duration(500)
                    .ease("linear")
                    .attr("transform", "translate(" + x(0) + ",0)");


                // elimino el dato mas viejo del array
                data.shift();

                // actualizo el texto con el valor actual
                svg.select("text")
                    .text(function () {

                        var Vcc = 5; 
                        var Res = 10000;
                        var Vin = opacidad (message.split(",")[1]);

                        var total = Res + Vin;
                            total = total / Res;
                            total = total * Vcc;

                        return (opacidad(message.split(",")[1]) * 100).toFixed(1);


                        //por las dudas (y temporalmente) pongo la conversión de volts a luxes para el LDR

                        /*
                        // Vo = Vcc(R/(R+Vin)) que sería Vo los luxes, Vcc son 5v en nuestro circuito y no se modifica,
                        R sería 10.000 (el valor provisorio de nuestra resistencia), y Vin es el valor de nuestro sensor, q va de 0-1023
                        */
                } );

            }
        });        


    </script>

</body>
</html>